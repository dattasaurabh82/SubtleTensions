- name: Setup and Update Raspberry Pi for Bootable Serial Monitor
  hosts: raspberry_pi4
  become: 'yes'
  vars:
    motd_content: |
      ______ _____ _____ _____ _____ __       _____ _____ _____ 
      |   __|   __| __  |     |  _  |  |     |     |     |   | |
      |__   |   __|    -|-   -|     |  |__   | | | |  |  | | | |
      |_____|_____|__|__|_____|__|__|_____|  |_|_|_|_____|_|___|
                                                          
      Welcome to Serial Monitor
      By: Saurabh Datta
      2024-2025                                             

  tasks:
    - name: Update apt cache (equivalent to apt-get update -y)
      apt:
        update_cache: 'yes'
        force_apt_get: 'yes'
    
    - name: Hide Raspberry Pi logo during boot and disable logo on top left corner
      lineinfile:
        path: /boot/firmware/cmdline.txt
        regexp: '^(.*)$'
        line: '\1 logo.nologo console_logo.enabled=0'
        backrefs: yes
        
    - name: Set custom MOTD
      copy:
        content: "{{ motd_content }}"
        dest: /etc/motd
        owner: root
        group: root
        mode: '0644'

    - name: Install required packages (incl. new ones)
      apt:
        name:
          - git
          - tmux
          - neofetch
          - vim
          - screen
          - minicom
          - lsof
          - net-tools
          - moreutils
          - curl
        state: present
        force_apt_get: 'yes'

    - name: Download and install Arduino CLI
      shell: |
        curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
        mv ./bin/arduino-cli /usr/bin/
      args:
        creates: /usr/bin/arduino-cli
  
    - name: Backup existing .bashrc
      copy:
        src: /home/{{ ansible_user }}/.bashrc
        dest: /home/{{ ansible_user }}/.bashrc.backup
        remote_src: yes
        force: no

    - name: Create new .bashrc file
      copy:
        src: /home/{{ ansible_user }}/.bashrc
        dest: /home/{{ ansible_user }}/.bashrc.new
        remote_src: yes

    - name: Add serial monitor prompt to .bashrc.new
      blockinfile:
        path: /home/{{ ansible_user }}/.bashrc.new
        block: |
          # Serial Monitor Launch Prompt
          PORT=$(arduino-cli board list | awk '/Arduino Micro/ {print $1}')
          echo ""
          echo -en "\033[33mLaunch serial monitor?\033[0m \033[34m(y\033[0m/\033[31mN\033[0m): "
          read -t 10 answer

          if [[ $answer =~ ^[Yy]$ ]]; then
              if [ -e "$PORT" ]; then
                  sudo killall screen 2>/dev/null
                  sleep 1
                  screen "$PORT" 115200
              else
                  echo "Error: $PORT not found!"
                  echo "Check if device is connected."
              fi
          fi
        marker: "# {mark} SERIAL MONITOR BLOCK"
        create: yes

    - name: Display installation complete message
      debug:
        msg: >-
          System Configuration and Installation complete!